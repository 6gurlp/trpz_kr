<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>CI Pipelines Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { padding: 2rem; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">CI Pipeline Demo UI</h1>

    <section class="mb-5">
        <h2>Створити пайплайн</h2>
        <form id="create-form" class="row g-2">
            <div class="col-sm-8 col-md-6">
                <label class="form-label" for="create-name">Назва</label>
                <input class="form-control" id="create-name" name="name" placeholder="My Pipeline" required>
            </div>
            <div class="col-sm-4 align-self-end">
                <button class="btn btn-primary" type="submit">Створити</button>
            </div>
        </form>
        <div id="create-result" class="mt-3"></div>
    </section>

    <section class="mb-5">
        <div class="d-flex align-items-center mb-2">
            <h2 class="me-3 mb-0">Список пайплайнів</h2>
            <button id="refresh-list" class="btn btn-outline-secondary btn-sm">Оновити</button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered" id="pipelines-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Назва</th>
                    <th>Стан</th>
                    <th>Дії</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <section class="mb-5">
        <h2>Деталі пайплайна</h2>
        <form id="fetch-form" class="row g-2">
            <div class="col-sm-6 col-md-4">
                <label class="form-label" for="pipeline-id">ID</label>
                <input class="form-control" id="pipeline-id" name="id" type="number" min="1" placeholder="1" required>
            </div>
            <div class="col-sm-4 align-self-end">
                <button class="btn btn-outline-primary" type="submit">Завантажити</button>
            </div>
        </form>
        <div id="pipeline-details" class="mt-3"></div>
    </section>

    <section class="mb-5">
        <h2>Mediator demo</h2>
        <form id="mediator-form" class="row g-2">
            <div class="col-md-4">
                <label class="form-label" for="mediator-name">Назва пайплайна</label>
                <input class="form-control" id="mediator-name" name="name" placeholder="DemoPipeline" value="DemoPipeline">
            </div>
            <div class="col-md-4 align-self-end">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="fail-tests" name="failTests">
                    <label class="form-check-label" for="fail-tests">Fail tests</label>
                </div>
            </div>
            <div class="col-md-4 align-self-end">
                <button class="btn btn-success" type="submit">Запустити демо</button>
            </div>
        </form>
        <div id="mediator-result" class="mt-3"></div>
    </section>
</div>

<script>
    const api = {
        pipelines: '/demo/pipelines',
        mediator: '/demo/mediator/run'
    };

    const createForm = document.getElementById('create-form');
    const createResult = document.getElementById('create-result');
    const pipelinesTableBody = document.querySelector('#pipelines-table tbody');
    const refreshListButton = document.getElementById('refresh-list');
    const fetchForm = document.getElementById('fetch-form');
    const pipelineDetails = document.getElementById('pipeline-details');
    const mediatorForm = document.getElementById('mediator-form');
    const mediatorResult = document.getElementById('mediator-result');

    function renderPipelineRow(pipeline) {
        return `
            <tr>
                <td>${pipeline.id}</td>
                <td>${pipeline.name}</td>
                <td>${pipeline.state}</td>
                <td class="d-flex flex-wrap gap-1">
                    ${['queue', 'start', 'succeed', 'fail', 'cancel'].map(action => `
                        <button class="btn btn-sm btn-outline-primary" data-action="${action}" data-id="${pipeline.id}">${action}</button>
                    `).join('')}
                </td>
            </tr>`;
    }

    function renderHistory(history) {
        if (!history || history.length === 0) {
            return '<p class="text-muted">Історія порожня</p>';
        }
        return '<ul>' + history.map(item => `<li>${item}</li>`).join('') + '</ul>';
    }

    function renderPipelineDetails(pipeline) {
        pipelineDetails.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">${pipeline.name} (ID: ${pipeline.id})</h5>
                    <p class="card-text mb-1"><strong>Стан:</strong> ${pipeline.state}</p>
                    <div>
                        <strong>Історія:</strong>
                        ${renderHistory(pipeline.history)}
                    </div>
                </div>
            </div>
        `;
    }

    async function handleResponse(response) {
        if (!response.ok) {
            const message = await response.text();
            throw new Error(message || 'Помилка сервера');
        }
        return response.json();
    }

    async function loadPipelines() {
        pipelinesTableBody.innerHTML = '<tr><td colspan="4">Завантаження...</td></tr>';
        try {
            const response = await fetch(api.pipelines);
            const data = await handleResponse(response);
            if (data.length === 0) {
                pipelinesTableBody.innerHTML = '<tr><td colspan="4" class="text-muted">Немає пайплайнів</td></tr>';
                return;
            }
            pipelinesTableBody.innerHTML = data.map(renderPipelineRow).join('');
        } catch (err) {
            pipelinesTableBody.innerHTML = `<tr><td colspan="4" class="text-danger">${err.message}</td></tr>`;
        }
    }

    createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(createForm);
        const name = formData.get('name');
        createResult.textContent = 'Створення...';
        try {
            const response = await fetch(`${api.pipelines}?name=${encodeURIComponent(name)}`, { method: 'POST' });
            const pipeline = await handleResponse(response);
            createResult.innerHTML = `<div class="alert alert-success">Створено пайплайн ID ${pipeline.id}</div>`;
            loadPipelines();
        } catch (err) {
            createResult.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
    });

    refreshListButton.addEventListener('click', loadPipelines);

    pipelinesTableBody.addEventListener('click', async (e) => {
        const button = e.target.closest('button[data-action]');
        if (!button) return;
        const action = button.dataset.action;
        const id = button.dataset.id;
        button.disabled = true;
        button.textContent = '...';
        try {
            const response = await fetch(`${api.pipelines}/${id}/${action}`, { method: 'POST' });
            const pipeline = await handleResponse(response);
            renderPipelineDetails(pipeline);
            await loadPipelines();
        } catch (err) {
            alert(err.message);
        } finally {
            button.disabled = false;
            button.textContent = action;
        }
    });

    fetchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = new FormData(fetchForm).get('id');
        pipelineDetails.textContent = 'Завантаження...';
        try {
            const response = await fetch(`${api.pipelines}/${id}`);
            const pipeline = await handleResponse(response);
            renderPipelineDetails(pipeline);
        } catch (err) {
            pipelineDetails.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
    });

    mediatorForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        mediatorResult.textContent = 'Запуск демо...';
        const formData = new FormData(mediatorForm);
        const params = new URLSearchParams({
            name: formData.get('name') || '',
            failTests: formData.get('failTests') ? 'true' : 'false'
        });
        try {
            const response = await fetch(`${api.mediator}?${params.toString()}`);
            const result = await handleResponse(response);
            mediatorResult.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Pipeline: ${result.pipeline.name} (ID: ${result.pipeline.id})</h5>
                        <p class="card-text"><strong>Стан:</strong> ${result.pipeline.state}</p>
                        <p class="card-text"><strong>Результат job:</strong> ${result.job.status}</p>
                        <div><strong>Нотифікації:</strong> ${result.notifications.join(', ')}</div>
                    </div>
                </div>
            `;
            loadPipelines();
        } catch (err) {
            mediatorResult.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
    });

    loadPipelines();
</script>
</body>
</html>
